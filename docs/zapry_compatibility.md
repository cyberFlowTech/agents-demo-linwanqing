# Zapry å¹³å°å®Œå…¨å…¼å®¹æ€§æ¸…å•

## âœ… å·²å®Œæˆçš„å…¼å®¹æ€§å¤„ç†

### 1. æ•°æ®æ ¼å¼ä¿®å¤ (`utils/private_api_bot.py`)

#### User å¯¹è±¡
- âœ… `id`: å­—ç¬¦ä¸² â†’ æ•´æ•°è½¬æ¢
- âœ… `is_bot`: ç¼ºå¤± â†’ è‡ªåŠ¨è¡¥å…¨ï¼ˆé»˜è®¤ Falseï¼‰
- âœ… `first_name`: ç¼ºå¤± â†’ ä½¿ç”¨ username/id/"Bot"

#### Chat å¯¹è±¡
- âœ… `id`: å­—ç¬¦ä¸²/botç”¨æˆ·å â†’ ä» `from.id` æå–çœŸå®ç”¨æˆ·ID
- âœ… `type`: ç©ºå­—ç¬¦ä¸² â†’ é»˜è®¤ "private"
- âœ… ID è½¬æ¢ä¸ºæ•´æ•°

#### Message å¯¹è±¡
- âœ… `entities`: ç¼ºå¤± â†’ è‡ªåŠ¨ç”Ÿæˆï¼ˆæ£€æµ‹ `/` å‘½ä»¤ï¼‰

#### Update å¯¹è±¡
- âœ… å…¨å±€ Monkey Patch `User.de_json`
- âœ… å…¨å±€ Monkey Patch `Chat.de_json`
- âœ… å…¨å±€ Monkey Patch `Update.de_json`
- âœ… é€’å½’è§„èŒƒåŒ–æ‰€æœ‰åµŒå¥—å¯¹è±¡

### 2. API æ–¹æ³•å…¼å®¹ (`utils/private_api_bot.py`)

- âœ… `editMessageText`: 404 â†’ æ”¹ç”¨ `sendMessage`
- âœ… `answerCallbackQuery`: éœ€è¦ chat_id â†’ æ•è·å¼‚å¸¸å¿½ç•¥
- âœ… `getMe`: è¿”å›æ ¼å¼å¼‚å¸¸ â†’ è§„èŒƒåŒ–å¤„ç†

### 3. API é…ç½® (`config.py` + `.env`)

- âœ… Base URL: `https://openapi.mimo.immo/bot` ï¼ˆä¸å¸¦å°¾éƒ¨æ–œæ ï¼‰
- âœ… Secret Token: ç•™ç©ºï¼ˆZapry ä¸å‘é€ headerï¼‰
- âœ… Webhook URL: ä¸å¸¦ `?bot_token=` å‚æ•°

### 4. æ¶ˆæ¯æ ¼å¼å…¼å®¹ (`handlers/tarot_v2.py`)

- âœ… Markdown æ¸…ç†ï¼šè‡ªåŠ¨ç§»é™¤ `**`ã€`*`ã€`` ` ``
- âœ… ä¸ä½¿ç”¨ `parse_mode`
- âœ… æ‰€æœ‰æ¶ˆæ¯éƒ½ç»è¿‡ `_clean_markdown()` å¤„ç†

### 5. é”™è¯¯å¤„ç†

- âœ… æ‰€æœ‰ API è°ƒç”¨éƒ½æœ‰ try-catch
- âœ… å…³é”®é”™è¯¯æœ‰é™çº§æ–¹æ¡ˆ
- âœ… ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•

### 6. ä¼šè¯ç®¡ç†

- âœ… ä½¿ç”¨ `tarot_drawn_names` è€Œä¸æ˜¯ä¸å­˜åœ¨çš„ `index`
- âœ… å®Œæ•´çš„ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… è¶…æ—¶è‡ªåŠ¨æ¸…ç†
- âœ… é˜²é‡å¤é€»è¾‘

---

## ğŸ§ª æµ‹è¯•æ¸…å•

### åŸºç¡€åŠŸèƒ½æµ‹è¯•

- [ ] `/start` - æ¬¢è¿æ¶ˆæ¯
- [ ] `/help` - å¸®åŠ©ä¿¡æ¯
- [ ] `/tarot` - æ— å‚æ•°æç¤º
- [ ] `/tarot é—®é¢˜` - æ­£å¸¸å åœæµç¨‹

### æ¸è¿›å¼æŠ½ç‰Œæµ‹è¯•

- [ ] æŠ½ 1 å¼  â†’ ç”Ÿæˆæ€»ç»“
- [ ] æŠ½ 2 å¼  â†’ ç”Ÿæˆæ€»ç»“
- [ ] æŠ½ 3 å¼  â†’ ç”Ÿæˆæ€»ç»“
- [ ] æŠ½ 5 å¼  â†’ ç”Ÿæˆæ€»ç»“
- [ ] ä¸­é€”ç‚¹å‡»"ç»“æŸå åœ"
- [ ] é˜²é‡å¤ï¼šåŒä¸€ä¼šè¯ä¸æŠ½åˆ°ç›¸åŒç‰Œ

### ä¼šè¯ç®¡ç†æµ‹è¯•

- [ ] 5åˆ†é’Ÿè¶…æ—¶è‡ªåŠ¨æ¸…ç†
- [ ] å†·å´æœŸæç¤ºï¼ˆ5åˆ†é’Ÿï¼‰
- [ ] ä¼šè¯æ—¶é—´è‡ªåŠ¨ç»­æœŸ

### é”™è¯¯åœºæ™¯æµ‹è¯•

- [ ] é—®é¢˜å¤ªçŸ­ï¼ˆ<5å­—ï¼‰
- [ ] é—®é¢˜å¤ªé•¿ï¼ˆ>200å­—ï¼‰
- [ ] ä¼šè¯è¶…æ—¶åç‚¹å‡»æŒ‰é’®
- [ ] å†·å´æœŸå†…å‘èµ·å åœ

### Zapry å…¼å®¹æ€§æµ‹è¯•

- [ ] Markdown æ ‡è®°è¢«æ­£ç¡®æ¸…ç†
- [ ] å‘½ä»¤è¢«æ­£ç¡®è¯†åˆ«ï¼ˆentitiesï¼‰
- [ ] æ¶ˆæ¯å‘é€æˆåŠŸï¼ˆsendMessageï¼‰
- [ ] æŒ‰é’®ç‚¹å‡»æ­£å¸¸ï¼ˆå¿½ç•¥ callback é”™è¯¯ï¼‰
- [ ] Chat ID æ­£ç¡®ï¼ˆä¸æ˜¯ bot ç”¨æˆ·åï¼‰
- [ ] User å¯¹è±¡å®Œæ•´ï¼ˆè¡¥å…¨ first_name, is_botï¼‰

---

## ğŸ› å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: Chat ID æ˜¯ bot ç”¨æˆ·å
**ç°è±¡**: `chat.id = "zapry_tarot_bot"`  
**åŸå› **: Zapry ç§èŠè¿”å›é”™è¯¯çš„ chat.id  
**è§£å†³**: âœ… ä» `message.from.id` æå–çœŸå®ç”¨æˆ· ID

### é—®é¢˜ 2: User ç¼ºå°‘ is_bot
**ç°è±¡**: `TypeError: missing 1 required positional argument: 'is_bot'`  
**åŸå› **: Zapry çš„ User å¯¹è±¡ä¸åŒ…å« is_bot å­—æ®µ  
**è§£å†³**: âœ… è‡ªåŠ¨è¡¥å…¨ä¸º Falseï¼ˆæ™®é€šç”¨æˆ·ï¼‰æˆ– Trueï¼ˆbotï¼‰

### é—®é¢˜ 3: User ç¼ºå°‘ first_name
**ç°è±¡**: `TypeError: missing 1 required positional argument: 'first_name'`  
**åŸå› **: Zapry çš„ bot User å¯¹è±¡ä¸åŒ…å« first_name  
**è§£å†³**: âœ… ä½¿ç”¨ username/id/"Bot" ä½œä¸ºæ›¿ä»£

### é—®é¢˜ 4: Chat ç¼ºå°‘ type
**ç°è±¡**: `TypeError: missing 1 required positional argument: 'type'`  
**åŸå› **: Zapry è¿”å›çš„ Chat.type ä¸ºç©ºå­—ç¬¦ä¸²  
**è§£å†³**: âœ… é»˜è®¤è®¾ç½®ä¸º "private"

### é—®é¢˜ 5: Message ç¼ºå°‘ entities
**ç°è±¡**: CommandHandler ä¸å·¥ä½œï¼Œå‘½ä»¤æ— æ³•è¯†åˆ«  
**åŸå› **: Zapry ä¸å‘é€ entities å­—æ®µ  
**è§£å†³**: âœ… æ£€æµ‹ `/` å¼€å¤´è‡ªåŠ¨ç”Ÿæˆ bot_command entity

### é—®é¢˜ 6: editMessageText è¿”å› 404
**ç°è±¡**: `Invalid server response: "404 page not found"`  
**åŸå› **: Zapry ä¸æ”¯æŒ editMessageText API  
**è§£å†³**: âœ… æ”¹ç”¨ sendMessage å‘é€æ–°æ¶ˆæ¯

### é—®é¢˜ 7: answerCallbackQuery éœ€è¦ chat_id
**ç°è±¡**: `Field validation for 'ChatId' failed on the 'required' tag`  
**åŸå› **: Zapry çš„ API è¦æ±‚é¢å¤–å‚æ•°  
**è§£å†³**: âœ… æ•è·å¼‚å¸¸å¿½ç•¥ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰

### é—®é¢˜ 8: Markdown ä¸è¢«è§£æ
**ç°è±¡**: `**ç²—ä½“**` æ˜¾ç¤ºä¸ºåŸå§‹æ–‡æœ¬  
**åŸå› **: Zapry ä¸æ”¯æŒ Markdown æ ¼å¼  
**è§£å†³**: âœ… è‡ªåŠ¨æ¸…ç†æ‰€æœ‰ Markdown æ ‡è®°

### é—®é¢˜ 9: Secret Token Header
**ç°è±¡**: `HTTP 403: Request did not include the secret token`  
**åŸå› **: Zapry ä¸å‘é€ `X-Telegram-Bot-Api-Secret-Token` header  
**è§£å†³**: âœ… `.env` ä¸­ WEBHOOK_SECRET_TOKEN ç•™ç©º

### é—®é¢˜ 10: API URL æ ¼å¼
**ç°è±¡**: 404 é”™è¯¯  
**åŸå› **: Zapry æ ¼å¼ä¸º `/botTOKEN/method`ï¼ˆä¸æ˜¯ `/bot/TOKEN/method`ï¼‰  
**è§£å†³**: âœ… Base URL ä¸å¸¦å°¾éƒ¨æ–œæ 

---

## ğŸ¯ å®Œå…¨å…¼å®¹æ€§ä¿è¯

### è‡ªåŠ¨åŒ–å¤„ç†ï¼ˆæ— éœ€æ‰‹åŠ¨å¹²é¢„ï¼‰

1. **æ•°æ®æ ¼å¼**ï¼šå…¨éƒ¨é€šè¿‡ Monkey Patch è‡ªåŠ¨ä¿®å¤
2. **API å·®å¼‚**ï¼šExtBot è¦†ç›–æ–¹æ³•è‡ªåŠ¨å¤„ç†
3. **æ–‡æœ¬æ ¼å¼**ï¼š`_clean_markdown()` è‡ªåŠ¨æ¸…ç†
4. **é”™è¯¯æ¢å¤**ï¼šå®Œæ•´çš„ try-catch é“¾

### å¹³å°åˆ‡æ¢

åªéœ€ä¿®æ”¹ `.env` ä¸­çš„ä¸€è¡Œï¼š
```bash
# ä½¿ç”¨ Zapry
TG_PLATFORM=zapry

# ä½¿ç”¨æ ‡å‡† Telegram
TG_PLATFORM=telegram
```

ç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
- åˆ‡æ¢ Bot Token
- åˆ‡æ¢ API Base URL
- åˆ‡æ¢ Webhook URL
- åº”ç”¨å¯¹åº”çš„å…¼å®¹æ€§å¤„ç†

---

## ğŸ“ å¼€å‘å»ºè®®

### æ·»åŠ æ–°åŠŸèƒ½æ—¶

1. **ä¸è¦ä¾èµ– `editMessage`**
   - æ€»æ˜¯ä½¿ç”¨ `sendMessage`
   - æˆ–ä½¿ç”¨ `_send_or_edit_message()` è¾…åŠ©å‡½æ•°

2. **ä¸è¦ä¾èµ– Markdown**
   - ä½¿ç”¨ Emoji å¢å¼ºè¡¨è¾¾
   - ä½¿ç”¨åˆ†éš”çº¿ç»„ç»‡å†…å®¹
   - æ‰€æœ‰æ–‡æœ¬é€šè¿‡ `_clean_markdown()` å¤„ç†

3. **ä¸è¦ä¾èµ– callback response**
   - `query.answer()` ç”¨ try-catch åŒ…è£¹
   - å¤±è´¥ä¸å½±å“ä¸»æµç¨‹

4. **æ‰€æœ‰ API è°ƒç”¨éƒ½è¦æœ‰é”™è¯¯å¤„ç†**
   ```python
   try:
       await context.bot.send_message(...)
   except Exception as e:
       logger.error(f"å‘é€å¤±è´¥: {e}")
       # é™çº§æ–¹æ¡ˆ
   ```

---

## ğŸ‰ å…¼å®¹æ€§éªŒè¯

### å½“å‰çŠ¶æ€
- âœ… æ‰€æœ‰å·²çŸ¥ Zapry å·®å¼‚å·²å¤„ç†
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†é“¾
- âœ… é™çº§æ–¹æ¡ˆå®Œå¤‡
- âœ… æ—¥å¿—è®°å½•è¯¦ç»†
- âœ… å¯åœ¨ Telegram å’Œ Zapry é—´æ— ç¼åˆ‡æ¢

### ç”Ÿäº§å°±ç»ª
**ç³»ç»Ÿå·²å®Œå…¨å…¼å®¹ Zapry å¹³å°ï¼Œå¯æ”¾å¿ƒæŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼** ğŸš€
