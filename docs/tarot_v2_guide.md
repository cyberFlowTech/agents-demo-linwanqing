# 塔罗占卜系统 V2 - 渐进式抽牌

## 🎯 产品定位

一个专业的 Telegram 塔罗占卜机器人，采用渐进式抽牌设计，提供灵活的占卜体验。

### 核心特点
- **渐进式抽牌**：用户可自主选择抽取 1-5 张牌
- **动态牌位**：根据张数自动匹配解读框架
- **实时反馈**：每张牌后立即获得解析
- **智能防刷**：5分钟冷却机制
- **会话管理**：5分钟超时自动重置

---

## 📱 使用流程

### 1️⃣ 发起占卜

```
/tarot 你的问题
```

**示例**：
- `/tarot 我应该换工作吗？`
- `/tarot 这段感情会有结果吗？`
- `/tarot 未来一个月的运势如何？`

### 2️⃣ 问题校验

系统会自动校验：
- ✅ 不能为空
- ✅ 至少 5 个字
- ✅ 不超过 200 字

### 3️⃣ 渐进式抽牌

每抽一张牌后，会显示：
- 🎴 牌名 + 正/逆位
- 📍 当前牌位含义
- 💫 简短解析（2-4句）
- 🔑 关键词

然后提供三个选择：
- **➕ 继续抽牌**：抽取下一张（最多5张）
- **📜 生成总结**：结束并生成完整报告
- **❌ 结束占卜**：放弃本次占卜

### 4️⃣ 生成总结

点击"📜 生成总结"后，系统会提供：
- 🌟 总体趋势（1句话概括）
- 🎴 牌阵整合解读
- 💡 2-3条行动建议
- ⚠️ 风险提醒
- 📢 免责声明

---

## 🎴 牌位逻辑

系统会根据抽牌数量自动匹配牌位含义：

| 张数 | 牌位含义 |
|-----|---------|
| 1张 | 当前核心能量 |
| 2张 | 当前状态 + 影响因素 |
| 3张 | 过去 / 现在 / 未来 |
| 4张 | 过去 / 现在 / 未来 + 隐藏因素 |
| 5张 | 过去 / 现在 / 未来 + 隐藏因素 + 行动建议 |

---

## ⚙️ 系统规则

### 防刷机制
- ✅ 每次占卜完成后，冷却 **5 分钟**
- ✅ 冷却期间会提示剩余时间

### 会话管理
- ✅ 会话超时时间：**5 分钟**
- ✅ 超过5分钟未操作，自动清理会话
- ✅ 每次交互自动续期

### 抽牌规则
- ✅ 最多抽取 **5 张**牌
- ✅ 同一会话不会抽到重复的牌
- ✅ 可在任意张数结束并生成总结

---

## 🎯 使用示例

### 完整占卜流程

1. **发起占卜**
```
用户: /tarot 我应该换工作吗？
Bot: 🔮 塔罗占卜开始
     💭 你的问题：我应该换工作吗？
     
     请在心中默念你的问题...
     当你准备好时，点击下方按钮抽取第一张牌。
     
     [🎴 抽取第 1 张牌]
```

2. **抽取第一张牌**
```
Bot: 🎴 第 1 张牌
     📍 牌位：当前核心能量
     🃏 牌名：The Star (星星) 正位
     
     ━━━━━━━━━━━━━━━━━
     
     📍 当前核心能量显示：
     
     希望与信念是你当前的核心能量。你正处于充满可能性的阶段。
     
     💫 关键词：希望，信念，灵感
     
     ━━━━━━━━━━━━━━━━━
     
     已抽取 1/5 张
     
     [➕ 继续抽第 2 张牌] [📜 生成总结] [❌ 结束占卜]
```

3. **继续抽牌或生成总结**
- 用户可选择继续抽取（最多5张）
- 或在任意张数点击"📜 生成总结"

4. **最终总结**
```
Bot: ━━━━━━━━━━━━━━━━━
     🔮 塔罗占卜总结 🔮
     ━━━━━━━━━━━━━━━━━
     
     💭 你的问题
     我应该换工作吗？
     
     ━━━━━━━━━━━━━━━━━
     
     🌟 整体趋势：积极向上
     形势对你有利，保持信心前行。
     
     ━━━━━━━━━━━━━━━━━
     
     🎴 牌阵解读
     
     1. 当前核心能量：The Star (星星) 正位
     当前的核心能量是希望，这是积极的信号。
     
     2. 影响因素：The Wheel of Fortune (命运之轮) 正位
     主要影响因素是转变，这是积极的信号。
     
     3. 未来：The Sun (太阳) 正位
     未来趋势指向成功，这是积极的信号。
     
     ━━━━━━━━━━━━━━━━━
     
     💡 行动建议
     
     1. 把握当前的有利时机，积极行动
     2. 保持信心，但不要过度冒进
     3. 定期回顾进展，及时调整策略
     
     ━━━━━━━━━━━━━━━━━
     
     ⚠️ 风险提醒
     
     整体形势尚可，但仍需保持警惕。过度自信可能导致疏忽。
     
     ━━━━━━━━━━━━━━━━━
     
     📢 免责声明
     塔罗牌仅供参考，不构成任何决策建议。
     真正的选择权始终在你手中。
     
     [🔁 开始新占卜]
```

---

## 🔧 技术实现

### 核心功能

1. **会话状态管理**
   - 存储：`context.user_data`
   - 字段：`tarot_question`, `tarot_cards`, `tarot_last_action`, `tarot_drawn_indices`
   - 超时：5分钟自动清理

2. **冷却机制**
   - 存储：`context.bot_data['tarot_cooldown_{user_id}']`
   - 时间：300秒（5分钟）
   - 检查：每次 `/tarot` 命令时

3. **防重复抽牌**
   - 记录：`tarot_drawn_indices` (set)
   - 检查：每次抽牌时验证索引
   - 重试：最多10次尝试

4. **动态牌位解读**
   - 配置：`CARD_POSITIONS` 字典
   - 匹配：根据当前张数自动选择
   - 解读：针对不同牌位生成个性化文本

### 兼容性处理

- ✅ Zapry API 完全兼容
- ✅ 自动清理 Markdown 标记
- ✅ 不使用 `editMessageText`（发送新消息）
- ✅ 忽略 `answerCallbackQuery` 错误

---

## 📊 数据流程

```
用户发起 /tarot 
  ↓
校验问题 + 冷却检查
  ↓
初始化会话状态
  ↓
显示抽牌按钮
  ↓
用户点击抽牌 ← ─┐
  ↓              │
抽取一张牌      │
  ↓              │
生成简短解析    │
  ↓              │
显示按钮:       │
[继续] [总结] [结束]
  │              │
  └──继续抽牌────┘
  ↓
生成完整总结
  ↓
设置冷却
  ↓
清理会话
```

---

## 🎨 产品优势

### 用户体验
1. **灵活控制**：用户自主决定抽牌数量
2. **即时反馈**：每张牌后立即获得解析
3. **渐进式参与**：增强仪式感和期待感
4. **清晰引导**：每步都有明确的选择项

### 专业性
1. **动态牌位**：根据张数自动匹配专业框架
2. **整合解读**：不是简单罗列，而是系统性分析
3. **行动建议**：给出具体可执行的指导
4. **风险提醒**：负责任的占卜态度

### 技术稳定性
1. **会话管理**：防止数据混乱
2. **防刷机制**：避免滥用
3. **超时处理**：自动清理资源
4. **错误恢复**：优雅处理异常

---

## 🚀 快速开始

1. **重启机器人**
```bash
python3 main.py
```

2. **发送命令**
```
/tarot 你的问题
```

3. **开始占卜**
按提示操作即可！

---

## 📝 后续优化方向

1. **群组功能**
   - 群内仅显示引导信息
   - 引导用户私聊机器人占卜

2. **历史记录**
   - 保存用户的占卜历史
   - 支持查看过往结果

3. **统计分析**
   - 用户占卜次数统计
   - 热门问题分析

4. **个性化**
   - 根据用户历史调整解读风格
   - 支持自定义牌阵

---

**✨ 享受你的塔罗占卜之旅！**
